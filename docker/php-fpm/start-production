#!/bin/bash
set -euo pipefail

echo "ğŸš€ Starting Easy!Appointments Production Container"

# Function to safely copy files
safe_copy() {
    local src="$1"
    local dest="$2"
    if [ -e "$src" ]; then
        cp -rf "$src" "$dest"
        echo "âœ… Copied $src to $dest"
    else
        echo "âš ï¸  Source not found: $src"
    fi
}

# Function to create directory with proper permissions
ensure_dir() {
    local dir="$1"
    local mode="${2:-755}"
    if [ ! -d "$dir" ]; then
        mkdir -p "$dir"
        chmod "$mode" "$dir"
        echo "âœ… Created directory: $dir with permissions $mode"
    fi
}

# Check if this is the first run by looking for a marker file
INIT_MARKER="/var/www/html/.docker-init-complete"

if [ ! -f "$INIT_MARKER" ]; then
    echo "ğŸ”§ First run detected - initializing shared volume..."
    
    # Ensure we have the basic directory structure
    ensure_dir "/var/www/html/application" 755
    ensure_dir "/var/www/html/assets" 755
    ensure_dir "/var/www/html/system" 755
    ensure_dir "/var/www/html/storage" 755
    
    # Copy application files (only if not already present)
    if [ ! -d "/var/www/html/application/controllers" ]; then
        echo "ğŸ“ Copying application files..."
        cp -rf /tmp/app/application/* /var/www/html/application/ 2>/dev/null || true
    fi
    
    # Copy assets files (only if not already present)
    if [ ! -d "/var/www/html/assets/css" ] || [ ! -d "/var/www/html/assets/js" ]; then
        echo "ğŸ¨ Copying built assets..."
        cp -rf /tmp/app/assets/* /var/www/html/assets/ 2>/dev/null || true
    fi
    
    # Copy system files (only if not already present)
    if [ ! -d "/var/www/html/system/core" ]; then
        echo "âš™ï¸  Copying system files..."
        cp -rf /tmp/app/system/* /var/www/html/system/ 2>/dev/null || true
    fi
    
    # Copy vendor directory (only if not already present)
    if [ ! -d "/var/www/html/vendor" ]; then
        echo "ğŸ“¦ Copying vendor dependencies..."
        cp -rf /tmp/app/vendor /var/www/html/ 2>/dev/null || true
    fi
    
    # Copy essential files
    echo "ğŸ“„ Copying essential files..."
    safe_copy "/tmp/app/index.php" "/var/www/html/"
    safe_copy "/tmp/app/patch.php" "/var/www/html/"
    
    # Set proper ownership and permissions for the appuser
    echo "ğŸ” Setting correct permissions..."
    chown -R appuser:appuser /var/www/html/ 2>/dev/null || true
    
    # Ensure storage directories have proper permissions
    find /var/www/html/storage -type d -exec chmod 755 {} \; 2>/dev/null || true
    find /var/www/html/storage -type f -exec chmod 644 {} \; 2>/dev/null || true
    
    # Ensure assets are readable
    find /var/www/html/assets -type d -exec chmod 755 {} \; 2>/dev/null || true
    find /var/www/html/assets -type f -exec chmod 644 {} \; 2>/dev/null || true
    
    # Create initialization marker
    touch "$INIT_MARKER"
    chown appuser:appuser "$INIT_MARKER" 2>/dev/null || true
    
    echo "âœ… Volume initialization completed!"
else
    echo "â™»ï¸  Volume already initialized, skipping..."
fi

# Switch to appuser for running the application
echo "ğŸ‘¤ Switching to appuser and starting php-fpm..."
exec gosu appuser php-fpm
